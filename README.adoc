= Gradle – GCS Build Cache
:toc:
:icons: font
:source-highlighter: coderay

This Settings plugin provides a *remote build cache* backed by *Google Cloud Storage (GCS)*.
It can also be registered manually without applying the plugin.

== Requirements

* Gradle 9.x (built and tested with 9.2.1)
* JDK 17+ to run Gradle
* A GCS bucket and appropriate IAM on your project/bucket

== Installation

=== Recommended: apply the Settings plugin (Kotlin DSL)

.settings.gradle.kts
[source,kotlin]
----
plugins {
    id("net.idlestate.gradle-gcs-build-cache") version "1.4.0"
}

// Configure the remote cache (the plugin registers the service for you)
buildCache {
    // Optionally disable local cache in CI
    local {
        isEnabled = true
    }

    remote<net.idlestate.gradle.caching.GCSBuildCache> {
        // credentials = "" uses Google ADC if left empty (recommended on CI)
        credentials = "/path/to/service-account.json"    // optional
        bucket = "my-bucket"                             // required
        prefix = "app-cache"                             // optional
        refreshAfterSeconds = 86400                      // optional (24h)
        writeThreshold = 8 * 1024 * 1024                 // optional (8 MiB)
        isEnabled = true
        isPush = true
    }
}
----

=== Manual registration (Kotlin DSL)

.settings.gradle.kts
[source,kotlin]
----
import net.idlestate.gradle.caching.GCSBuildCache
import net.idlestate.gradle.caching.GCSBuildCacheServiceFactory
import org.gradle.kotlin.dsl.registerBuildCacheService
import org.gradle.kotlin.dsl.remote

plugins {
    id("net.idlestate.gradle-gcs-build-cache") version "1.4.0" apply false
}

buildCache {
    local {
        isEnabled = true
    }

    registerBuildCacheService<GCSBuildCache>(GCSBuildCacheServiceFactory::class)

    remote<GCSBuildCache> {
        credentials = "/path/to/service-account.json" // optional; empty uses ADC
        bucket = "my-bucket"
        prefix = "app-cache"
        refreshAfterSeconds.set = 86400
        writeThreshold = 8 * 1024 * 1024
        isEnabled = true
        isPush = true
    }
}
----

=== Groovy DSL variants

.settings.gradle
[source,groovy]
----
import net.idlestate.gradle.caching.GCSBuildCache
import net.idlestate.gradle.caching.GCSBuildCacheServiceFactory

plugins {
    id "net.idlestate.gradle-gcs-build-cache" version "1.4.0" apply false
}

buildCache {
    local {
        enabled = true
    }

    registerBuildCacheService(GCSBuildCache, GCSBuildCacheServiceFactory)

    remote(GCSBuildCache) {
        credentials = 'my-key.json' // optional; empty uses ADC
        bucket = 'my-bucket'
        prefix = 'app-cache'
        refreshAfterSeconds = 86400
        writeThreshold = 8 * 1024 * 1024
        enabled = true
        push = true
    }
}
----

=== Using an init script (Kotlin)

.init.gradle.kts
[source,kts]
----
initscript {
    repositories { gradlePluginPortal() }
    dependencies { classpath("net.idlestate:gradle-gcs-build-cache:1.4.0") }
}

import net.idlestate.gradle.caching.GCSBuildCache
import net.idlestate.gradle.caching.GCSBuildCacheServiceFactory

beforeSettings {
    buildscript.repositories.add(gradlePluginPortal())
    buildscript.dependencies.add("classpath","net.idlestate:gradle-gcs-build-cache:1.4.0")

    buildCache {
        local { enabled = true }
        registerBuildCacheService<GCSBuildCache>(GCSBuildCacheServiceFactory::class)
        remote<GCSBuildCache> {
            credentials = "my-key.json" // optional; empty uses ADC
            bucket = "my-bucket"
            prefix = "app-cache"
            refreshAfterSeconds = 86400
            writeThreshold = 8 * 1024 * 1024
            enabled = true
            push = true
        }
    }
}
----

=== Using an init script (Groovy)

.init-build-cache.gradle
[source,groovy]
----
initscript {
    repositories { gradlePluginPortal() }
    dependencies { classpath 'net.idlestate:gradle-gcs-build-cache:1.4.0' }
}

import net.idlestate.gradle.caching.GCSBuildCache
import net.idlestate.gradle.caching.GCSBuildCacheServiceFactory

gradle.settingsEvaluated { settings ->
    settings.buildCache {
        local { enabled = true }
        registerBuildCacheService(GCSBuildCache, GCSBuildCacheServiceFactory)
        remote(GCSBuildCache) {
            credentials = 'my-key.json' // optional; empty uses ADC
            bucket = 'my-bucket'
            prefix = 'app-cache'
            refreshAfterSeconds = 86400
            writeThreshold = 8 * 1024 * 1024
            enabled = true
            push = true
        }
    }
}
----

Run with:

[source,bash]
----
./gradlew --build-cache --init-script init-build-cache.gradle <task>
----

== Configuration Options

The cache accepts the following options (in Kotlin DSL they are `Property<T>`s):

|===
| Option | Type | Default | Description

| `credentials`
| String
| `""`
| Path to a service account JSON key file. If empty, *Application Default Credentials (ADC)* are used.

| `bucket`
| String
| —
| Name of the GCS bucket to store cache entries. *Required.*

| `prefix`
| String
| unset
| Optional key prefix (acts like a folder).

| `refreshAfterSeconds`
| Int
| `0`
| If `> 0`, objects older than this threshold are “touched” on load (server-side rewrite) to keep them from lifecycle deletion.

| `writeThreshold`
| Int
| `8 * 1024 * 1024`
| Switches to a file-backed buffer when writing entries larger than the threshold (bytes).
|===

You can enable the build cache per run (`--build-cache`) or globally via `org.gradle.caching=true` in `gradle.properties`.

== Preparing Google Cloud Storage

=== Create a bucket (private, uniform access)

[source,bash]
----
PROJECT=<your-project>
REGION=<your-region>
BUCKET=<your-bucket>

gsutil mb -p "$PROJECT" -l "$REGION" -b on "gs://$BUCKET"
----

=== Grant permissions with IAM

Grant your CI/service account the *Storage Object Admin* role on the bucket (read/write and object rewrite):

[source,bash]
----
ACCOUNT=<service-account-name> # without domain

gcloud iam service-accounts create "$ACCOUNT" \
  --display-name "Gradle build cache (GCS)"

gsutil iam ch \
  serviceAccount:$ACCOUNT@$PROJECT.iam.gserviceaccount.com:roles/storage.objectAdmin \
  gs://$BUCKET
----

=== Credentials

*Preferred:* rely on *ADC* (no key files) on GCP/CI.
If you need a key file:

[source,bash]
----
KEY_FILE=cache-writer.json
gcloud iam service-accounts keys create "$KEY_FILE" \
  --iam-account "$ACCOUNT@$PROJECT.iam.gserviceaccount.com"
----

Then set `credentials` to the key path or export:

[source,bash]
----
export GOOGLE_APPLICATION_CREDENTIALS="$PWD/$KEY_FILE"
----

=== Lifecycle management (automatic cleanup)

Delete cached objects after 14 days:

.rules.json
[source,json]
----
{
  "rule": [
    { "action": { "type": "Delete" }, "condition": { "age": 14 } }
  ]
}
----

[source,bash]
----
gsutil lifecycle set rules.json "gs://$BUCKET"
----

== How it works (high level)

* Cache keys map to GCS object names (with optional `prefix`).
* Reads stream directly from GCS; writes spill to a file-backed buffer above `writeThreshold`.
* If `refreshAfterSeconds > 0`, frequently used entries are “touched” on load via a server-side copy to update create time so lifecycle rules don’t remove them prematurely.

== Troubleshooting

* **403 / 404** – verify bucket name and IAM bindings (e.g., `roles/storage.objectAdmin`) on the bucket.
* **Authentication** – if `credentials` is empty, ensure ADC is available or set `GOOGLE_APPLICATION_CREDENTIALS` to a service account key file.
* **No cache hits** – confirm the build cache is enabled (`--build-cache` or `org.gradle.caching=true`) and that `push` is enabled for the environment.

== License

Apache License, Version 2.0 (see `LICENSE`).
